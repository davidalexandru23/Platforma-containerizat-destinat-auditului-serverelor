{
    "$schema": "bittrail-template@1.0",
    "metadata": {
        "name": "NIST SP 800-53 Rev.5 (Moderate) - Linux Server Automated Audit Pack",
        "description": "Template de audit aliniat la NIST SP 800-53 Rev.5 (nivel Moderate), adaptat pentru servere Linux. Include controale tehnice si operationale, cu verificari automatizabile prin agent acolo unde este posibil (read-only).",
        "version": "1.1.0",
        "type": "NIST",
        "author": "BitTrail Platform",
        "createdAt": "2026-01-27T00:00:00Z"
    },
    "controls": [
        {
            "controlId": "AC-2",
            "title": "Account Management: inventar conturi si ciclul de viata",
            "category": "Access Control",
            "description": "Conturile sunt inventariate, revizuite periodic, iar conturile nefolosite sunt dezactivate/sterse conform politicii. (Family: AC)",
            "severity": "HIGH",
            "automatedChecks": [
                {
                    "checkId": "AC-2.a",
                    "title": "Inventar conturi locale",
                    "command": "TOTAL=$(wc -l < /etc/passwd); INTERACTIVE=$(grep -cE '/bin/(bash|sh|zsh|fish)$' /etc/passwd); NOLOGIN=$((TOTAL - INTERACTIVE)); echo \"TOTAL_ACCOUNTS=$TOTAL\"; echo \"INTERACTIVE=$INTERACTIVE\"; echo \"NOLOGIN=$NOLOGIN\"; cut -d: -f1,3,7 /etc/passwd | head -n 50; echo 'CHECK=PASS'",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "AC-2.b",
                    "title": "Conturi fara parola valida",
                    "command": "EMPTY=$(awk -F: '($2 == \"\") {print $1}' /etc/shadow 2>/dev/null | wc -l); echo \"EMPTY_PASSWORD=$EMPTY\"; if [ \"$EMPTY\" -eq 0 ]; then echo 'CHECK=PASS'; else echo 'CHECK=FAIL'; awk -F: '($2 == \"\") {print $1}' /etc/shadow 2>/dev/null; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "AC-2.c",
                    "title": "Conturi UID 0",
                    "command": "ROOT_ACCTS=$(awk -F: '$3 == 0 {print $1}' /etc/passwd | wc -l); echo \"UID0_ACCOUNTS=$ROOT_ACCTS\"; awk -F: '$3 == 0 {print $1}' /etc/passwd; if [ \"$ROOT_ACCTS\" -le 1 ]; then echo 'CHECK=PASS'; else echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": [
                {
                    "checkId": "AC-2.M1",
                    "title": "Verificare politica si review conturi",
                    "instructions": "Incarcati Politica de lifecycle (creare, modificare, dezactivare) si Dovada review-ului periodic (ex: lunar/trimestrial).",
                    "evidenceSpec": {
                        "allowUpload": true,
                        "allowLink": true
                    }
                }
            ]
        },
        {
            "controlId": "AC-3",
            "title": "Access Enforcement: permisii corecte pe fisiere si foldere critice",
            "category": "Access Control",
            "description": "Permisiunile pe fisiere critice sunt restrictive si aliniate la least privilege. (Family: AC)",
            "severity": "HIGH",
            "automatedChecks": [
                {
                    "checkId": "AC-3.a",
                    "title": "Permisii fisiere critice",
                    "command": "SCORE=0; TOTAL=0; for f in /etc/shadow /etc/gshadow /etc/sudoers /etc/ssh/sshd_config; do if [ -f \"$f\" ]; then TOTAL=$((TOTAL+1)); PERM=$(stat -c '%a' \"$f\" 2>/dev/null); OWNER=$(stat -c '%U' \"$f\" 2>/dev/null); echo \"$f owner=$OWNER perm=$PERM\"; if [ \"$OWNER\" = 'root' ]; then SCORE=$((SCORE+1)); fi; fi; done; echo \"CORRECT=$SCORE/$TOTAL\"; if [ \"$SCORE\" -eq \"$TOTAL\" ] && [ \"$TOTAL\" -gt 0 ]; then echo 'CHECK=PASS'; else echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "AC-3.b",
                    "title": "Fisiere world-writable",
                    "command": "COUNT=$(find / -xdev -type f -perm -0002 -not -path '/proc/*' -not -path '/sys/*' 2>/dev/null | wc -l); echo \"WORLD_WRITABLE_FILES=$COUNT\"; if [ \"$COUNT\" -eq 0 ]; then echo 'CHECK=PASS'; else echo 'CHECK=WARN'; find / -xdev -type f -perm -0002 -not -path '/proc/*' -not -path '/sys/*' 2>/dev/null | head -n 20; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": []
        },
        {
            "controlId": "AC-6",
            "title": "Least Privilege: sudo minim si fara NOPASSWD nejustificat",
            "category": "Access Control",
            "description": "Doar conturile necesare au privilegii elevate, iar sudo este configurat minim, auditabil. (Family: AC)",
            "severity": "CRITICAL",
            "automatedChecks": [
                {
                    "checkId": "AC-6.a",
                    "title": "NOPASSWD entries",
                    "command": "NOPASSWD=$(grep -rn 'NOPASSWD' /etc/sudoers /etc/sudoers.d 2>/dev/null | grep -cv '^#'); echo \"NOPASSWD_ENTRIES=$NOPASSWD\"; if [ \"$NOPASSWD\" -eq 0 ]; then echo 'CHECK=PASS'; else echo 'CHECK=WARN'; grep -rn 'NOPASSWD' /etc/sudoers /etc/sudoers.d 2>/dev/null | grep -v '^#'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "AC-6.b",
                    "title": "Sudo group size",
                    "command": "TOTAL=$(getent group sudo wheel 2>/dev/null | cut -d: -f4 | tr ',' '\\n' | sort -u | grep -c '.'); echo \"ADMIN_USERS=$TOTAL\"; if [ \"$TOTAL\" -le 5 ]; then echo 'CHECK=PASS'; else echo 'CHECK=EXCESSIVE'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": [
                {
                    "checkId": "AC-6.M1",
                    "title": "Verificare exceptii sudo",
                    "instructions": "Incarcati justificari aprobate pentru exceptii (daca exista).",
                    "evidenceSpec": {
                        "allowUpload": true,
                        "allowLink": true
                    }
                }
            ]
        },
        {
            "controlId": "AC-7",
            "title": "Unsuccessful Logon Attempts: blocare dupa incercari esuate",
            "category": "Access Control",
            "description": "Exista controale pentru limitarea incercarilor de autentificare esuate (faillock, pam_tally2, fail2ban). (Family: AC)",
            "severity": "HIGH",
            "automatedChecks": [
                {
                    "checkId": "AC-7.a",
                    "title": "Faillock configurare",
                    "command": "if [ -f /etc/security/faillock.conf ]; then echo 'FAILLOCK=CONFIGURED'; grep -v '^#' /etc/security/faillock.conf 2>/dev/null | grep -v '^$' | head -n 10; elif grep -q 'pam_faillock\\|pam_tally2' /etc/pam.d/* 2>/dev/null; then echo 'FAILLOCK=PAM_CONFIGURED'; else echo 'FAILLOCK=MISSING'; fi",
                    "expectedResult": "CONFIGURED",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "AC-7.b",
                    "title": "Fail2Ban status",
                    "command": "if command -v fail2ban-client >/dev/null 2>&1; then echo 'FAIL2BAN=ACTIVE'; fail2ban-client status 2>/dev/null | head -n 5; echo 'CHECK=PASS'; else echo 'FAIL2BAN=NOT_INSTALLED'; echo 'CHECK=WARN'; fi",
                    "expectedResult": "CHECK=",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": []
        },
        {
            "controlId": "AC-17",
            "title": "Remote Access: SSH hardening",
            "category": "Access Control",
            "description": "Accesul remote este configurat sigur (fara root login, parole dezactivate unde e posibil, setari moderne). (Family: AC)",
            "severity": "CRITICAL",
            "automatedChecks": [
                {
                    "checkId": "AC-17.a",
                    "title": "SSH PermitRootLogin",
                    "command": "VALUE=$(sshd -T 2>/dev/null | grep -i 'permitrootlogin' | awk '{print $2}'); if [ -z \"$VALUE\" ]; then VALUE=$(grep -i '^PermitRootLogin' /etc/ssh/sshd_config 2>/dev/null | awk '{print $2}'); fi; echo \"PermitRootLogin=$VALUE\"; if echo \"$VALUE\" | grep -qiE '^(no|prohibit-password)$'; then echo 'CHECK=PASS'; else echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "AC-17.b",
                    "title": "SSH Keys inventory",
                    "command": "KEYS=0; for d in /home/* /root; do if [ -f \"$d/.ssh/authorized_keys\" ]; then COUNT=$(wc -l < \"$d/.ssh/authorized_keys\" 2>/dev/null); KEYS=$((KEYS+COUNT)); echo \"$(basename $d): $COUNT keys\"; fi; done 2>/dev/null; echo \"TOTAL_SSH_KEYS=$KEYS\"; echo 'CHECK=PASS'",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": []
        },
        {
            "controlId": "IA-2",
            "title": "Identification and Authentication: metoda autentificare si MFA unde e aplicabil",
            "category": "Identity & Authentication",
            "description": "Sunt folosite mecanisme de autentificare adecvate (chei SSH, PAM), iar MFA este implementat unde e posibil pentru acces privilegiat. (Family: IA)",
            "severity": "HIGH",
            "automatedChecks": [
                {
                    "checkId": "IA-2.a",
                    "title": "PAM SSH config",
                    "command": "if [ -f /etc/pam.d/sshd ]; then echo 'PAM_SSH=CONFIGURED'; grep -v '^#' /etc/pam.d/sshd 2>/dev/null | grep -v '^$' | head -n 15; echo 'CHECK=PASS'; else echo 'PAM_SSH=MISSING'; echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "IA-2.b",
                    "title": "MFA modules presence",
                    "command": "FOUND=''; ls /lib*/security/*google_authenticator* 2>/dev/null && FOUND=\"$FOUND google-auth\"; ls /lib*/security/*oath* 2>/dev/null && FOUND=\"$FOUND oath\"; ls /lib*/security/*yubico* 2>/dev/null && FOUND=\"$FOUND yubico\"; ls /lib*/security/*pam_u2f* 2>/dev/null && FOUND=\"$FOUND u2f\"; if [ -n \"$FOUND\" ]; then echo \"MFA_MODULES=$FOUND\"; echo 'CHECK=PASS'; else echo 'MFA_MODULES=NONE'; echo 'CHECK=INFO'; fi",
                    "expectedResult": "CHECK=",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": [
                {
                    "checkId": "IA-2.M1",
                    "title": "Verificare MFA",
                    "instructions": "Incarcati Politica MFA (unde e obligatoriu) si Dovada configurarii MFA pentru conturi admin.",
                    "evidenceSpec": {
                        "allowUpload": true,
                        "allowLink": true
                    }
                }
            ]
        },
        {
            "controlId": "IA-5",
            "title": "Authenticator Management: politici parole si expirare",
            "category": "Identity & Authentication",
            "description": "Politicile de parola sunt configurate (complexitate, istoric, expirare) si sunt aplicate consistent. (Family: IA)",
            "severity": "HIGH",
            "automatedChecks": [
                {
                    "checkId": "IA-5.a",
                    "title": "Password aging config",
                    "command": "PASS_MAX=$(grep '^PASS_MAX_DAYS' /etc/login.defs 2>/dev/null | awk '{print $2}'); PASS_MIN=$(grep '^PASS_MIN_DAYS' /etc/login.defs 2>/dev/null | awk '{print $2}'); PASS_WARN=$(grep '^PASS_WARN_AGE' /etc/login.defs 2>/dev/null | awk '{print $2}'); echo \"PASS_MAX_DAYS=$PASS_MAX\"; echo \"PASS_MIN_DAYS=$PASS_MIN\"; echo \"PASS_WARN_AGE=$PASS_WARN\"; if [ -n \"$PASS_MAX\" ] && [ \"$PASS_MAX\" -le 365 ] 2>/dev/null; then echo 'CHECK=PASS'; else echo 'CHECK=WARN'; fi",
                    "expectedResult": "PASS_MAX_DAYS=",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "IA-5.b",
                    "title": "Password quality config",
                    "command": "if [ -f /etc/security/pwquality.conf ]; then echo 'PWQUALITY=CONFIGURED'; grep -v '^#' /etc/security/pwquality.conf 2>/dev/null | grep -v '^$' | head -n 15; echo 'CHECK=PASS'; elif grep -q 'pam_pwquality\\|pam_cracklib' /etc/pam.d/* 2>/dev/null; then echo 'PWQUALITY=PAM_CONFIGURED'; echo 'CHECK=PASS'; else echo 'PWQUALITY=MISSING'; echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": []
        },
        {
            "controlId": "AU-2",
            "title": "Audit Events: evenimente auditate si acoperire loguri",
            "category": "Logging & Monitoring",
            "description": "Sunt definite evenimentele care trebuie logate (auth, privilegii, schimbari configuratie, network). (Family: AU)",
            "severity": "HIGH",
            "automatedChecks": [
                {
                    "checkId": "AU-2.a",
                    "title": "Journald activ",
                    "command": "if systemctl is-active systemd-journald >/dev/null 2>&1; then echo 'JOURNALD=ACTIVE'; journalctl --disk-usage 2>/dev/null; echo 'CHECK=PASS'; else echo 'JOURNALD=INACTIVE'; echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "AU-2.b",
                    "title": "Auditd activ",
                    "command": "if systemctl is-active auditd >/dev/null 2>&1; then echo 'AUDITD=ACTIVE'; RULES=$(auditctl -l 2>/dev/null | wc -l); echo \"AUDIT_RULES=$RULES\"; echo 'CHECK=PASS'; else echo 'AUDITD=INACTIVE'; echo 'CHECK=WARN'; fi",
                    "expectedResult": "CHECK=",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": [
                {
                    "checkId": "AU-2.M1",
                    "title": "Verificare matrice audit",
                    "instructions": "Incarcati Matricea evenimente audit (ce, de ce, retentie, cine are acces).",
                    "evidenceSpec": {
                        "allowUpload": true,
                        "allowLink": true
                    }
                }
            ]
        },
        {
            "controlId": "AU-6",
            "title": "Audit Review: alertare si review periodic",
            "category": "Logging & Monitoring",
            "description": "Logurile sunt revizuite si exista mecanisme de alertare pentru evenimente critice. (Family: AU)",
            "severity": "MEDIUM",
            "automatedChecks": [
                {
                    "checkId": "AU-6.a",
                    "title": "Auth failures recente",
                    "command": "FAILURES=$(journalctl --no-pager -n 500 2>/dev/null | grep -ciE 'failed password|authentication failure'); echo \"AUTH_FAILURES_RECENT=$FAILURES\"; if [ \"$FAILURES\" -le 50 ]; then echo 'CHECK=PASS'; else echo 'CHECK=WARN'; fi",
                    "expectedResult": "CHECK=",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "AU-6.b",
                    "title": "Logrotate configurat",
                    "command": "if [ -f /etc/logrotate.conf ]; then echo 'LOGROTATE=CONFIGURED'; grep -cE 'rotate|weekly|daily|monthly' /etc/logrotate.conf 2>/dev/null; echo 'CHECK=PASS'; else echo 'LOGROTATE=MISSING'; echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": [
                {
                    "checkId": "AU-6.M1",
                    "title": "Verificare alertare",
                    "instructions": "Incarcati Reguli de alertare (SIEM, email, webhook) si dovezi ca functioneaza.",
                    "evidenceSpec": {
                        "allowUpload": true,
                        "allowLink": true
                    }
                }
            ]
        },
        {
            "controlId": "AU-9",
            "title": "Protection of Audit Information: acces restrictiv la loguri",
            "category": "Logging & Monitoring",
            "description": "Logurile sunt protejate contra modificarii/stergerii neautorizate, iar accesul este restrans. (Family: AU)",
            "severity": "HIGH",
            "automatedChecks": [
                {
                    "checkId": "AU-9.a",
                    "title": "Log directory permissions",
                    "command": "OWNER=$(stat -c '%U' /var/log 2>/dev/null); PERM=$(stat -c '%a' /var/log 2>/dev/null); echo \"LOG_DIR_OWNER=$OWNER\"; echo \"LOG_DIR_PERM=$PERM\"; if [ \"$OWNER\" = 'root' ]; then echo 'CHECK=PASS'; else echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": []
        },
        {
            "controlId": "CM-2",
            "title": "Baseline Configuration: configuratie de referinta si drift",
            "category": "Secure Configuration",
            "description": "Exista o configuratie de referinta si se detecteaza abateri (drift) intre audituri. (Family: CM)",
            "severity": "MEDIUM",
            "automatedChecks": [
                {
                    "checkId": "CM-2.a",
                    "title": "Baseline config hashes",
                    "command": "FOUND=0; for f in /etc/ssh/sshd_config /etc/sudoers /etc/sysctl.conf /etc/login.defs /etc/security/pwquality.conf; do if [ -f \"$f\" ]; then FOUND=$((FOUND+1)); echo \"$(sha256sum \"$f\")\"; fi; done; echo \"HASHED_FILES=$FOUND\"; if [ \"$FOUND\" -ge 3 ]; then echo 'CHECK=PASS'; else echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": []
        },
        {
            "controlId": "CM-6",
            "title": "Configuration Settings: sysctl hardening si setari de retea",
            "category": "Secure Configuration",
            "description": "Setarile sysctl relevante sunt aplicate si documentate. (Family: CM)",
            "severity": "MEDIUM",
            "automatedChecks": [
                {
                    "checkId": "CM-6.a",
                    "title": "Sysctl hardening keys",
                    "command": "SCORE=0; TOTAL=6; sysctl net.ipv4.ip_forward 2>/dev/null | grep -q '= 0' && SCORE=$((SCORE+1)); sysctl net.ipv4.conf.all.accept_redirects 2>/dev/null | grep -q '= 0' && SCORE=$((SCORE+1)); sysctl net.ipv4.conf.all.rp_filter 2>/dev/null | grep -q '= 1' && SCORE=$((SCORE+1)); sysctl net.ipv4.conf.default.accept_source_route 2>/dev/null | grep -q '= 0' && SCORE=$((SCORE+1)); sysctl kernel.randomize_va_space 2>/dev/null | grep -q '= 2' && SCORE=$((SCORE+1)); sysctl net.ipv4.conf.all.send_redirects 2>/dev/null | grep -q '= 0' && SCORE=$((SCORE+1)); echo \"SYSCTL_SCORE=$SCORE/$TOTAL\"; if [ \"$SCORE\" -ge 4 ]; then echo 'CHECK=PASS'; else echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": []
        },
        {
            "controlId": "CM-7",
            "title": "Least Functionality: servicii active si reducere suprafata atac",
            "category": "Secure Configuration",
            "description": "Sunt active doar serviciile necesare, iar cele inutile sunt dezactivate. (Family: CM)",
            "severity": "HIGH",
            "automatedChecks": [
                {
                    "checkId": "CM-7.a",
                    "title": "Servicii riscante active",
                    "command": "RISKY=''; for s in telnet.socket rsh.socket rlogin.socket vsftpd xinetd avahi-daemon cups; do systemctl is-active \"$s\" >/dev/null 2>&1 && RISKY=\"$RISKY $s\"; done; if [ -z \"$RISKY\" ]; then echo 'RISKY_SERVICES=NONE'; echo 'CHECK=PASS'; else echo \"RISKY_SERVICES=$RISKY\"; echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "CM-7.b",
                    "title": "Running services count",
                    "command": "if command -v systemctl >/dev/null 2>&1; then COUNT=$(systemctl list-units --type=service --state=running --no-pager | grep -c 'running'); echo \"RUNNING_SERVICES=$COUNT\"; if [ \"$COUNT\" -le 50 ]; then echo 'CHECK=PASS'; else echo 'CHECK=REVIEW'; fi; else echo 'SYSTEMCTL=NOT_AVAILABLE'; echo 'CHECK=WARN'; fi",
                    "expectedResult": "CHECK=",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": []
        },
        {
            "controlId": "CM-8",
            "title": "System Component Inventory: OS, kernel, pachete, runtime",
            "category": "Asset Management",
            "description": "Componentele sistemului sunt inventariate: OS, kernel, pachete, runtime container. (Family: CM)",
            "severity": "MEDIUM",
            "automatedChecks": [
                {
                    "checkId": "CM-8.a",
                    "title": "OS si Kernel",
                    "command": "if [ -f /etc/os-release ]; then . /etc/os-release; echo \"OS=$PRETTY_NAME\"; echo \"ID=$ID\"; fi; echo \"KERNEL=$(uname -r)\"; echo 'CHECK=PASS'",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "CM-8.b",
                    "title": "Package manager available",
                    "command": "if command -v dpkg >/dev/null 2>&1; then echo 'PKG_MGR=dpkg'; dpkg -l 2>/dev/null | tail -n +6 | wc -l | sed 's/^/PACKAGE_COUNT=/'; elif command -v rpm >/dev/null 2>&1; then echo 'PKG_MGR=rpm'; rpm -qa 2>/dev/null | wc -l | sed 's/^/PACKAGE_COUNT=/'; else echo 'PKG_MGR=NONE'; fi; echo 'CHECK=PASS'",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "CM-8.c",
                    "title": "Container runtime inventory",
                    "command": "if command -v docker >/dev/null 2>&1; then CONTAINERS=$(docker ps -q 2>/dev/null | wc -l); IMAGES=$(docker images -q 2>/dev/null | wc -l); echo \"DOCKER_CONTAINERS=$CONTAINERS\"; echo \"DOCKER_IMAGES=$IMAGES\"; echo 'CHECK=PASS'; else echo 'DOCKER=NOT_INSTALLED'; echo 'CHECK=PASS'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": []
        },
        {
            "controlId": "SC-7",
            "title": "Boundary Protection: firewall host si porturi ascultate",
            "category": "Network Security",
            "description": "Exista filtrare la nivel host, iar porturile ascultate sunt controlate. (Family: SC)",
            "severity": "CRITICAL",
            "automatedChecks": [
                {
                    "checkId": "SC-7.a",
                    "title": "Listening ports count",
                    "command": "COUNT=$(ss -lntup 2>/dev/null | grep -c LISTEN); echo \"LISTENING_PORTS=$COUNT\"; ss -lntup 2>/dev/null | head -n 30; if [ \"$COUNT\" -le 20 ]; then echo 'CHECK=PASS'; else echo 'CHECK=REVIEW'; fi",
                    "expectedResult": "CHECK=",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "SC-7.b",
                    "title": "Firewall activ",
                    "command": "if command -v ufw >/dev/null 2>&1; then STATUS=$(ufw status 2>/dev/null | head -1); echo \"$STATUS\"; if echo \"$STATUS\" | grep -qi 'active'; then echo 'FIREWALL=ACTIVE'; echo 'CHECK=PASS'; else echo 'FIREWALL=INACTIVE'; echo 'CHECK=FAIL'; fi; elif command -v nft >/dev/null 2>&1; then RULES=$(nft list ruleset 2>/dev/null | wc -l); if [ \"$RULES\" -gt 2 ]; then echo 'FIREWALL=ACTIVE'; echo 'CHECK=PASS'; else echo 'FIREWALL=INACTIVE'; echo 'CHECK=FAIL'; fi; elif command -v iptables >/dev/null 2>&1; then RULES=$(iptables -S 2>/dev/null | grep -cv '^-P'); if [ \"$RULES\" -gt 0 ]; then echo 'FIREWALL=ACTIVE'; echo 'CHECK=PASS'; else echo 'FIREWALL=INACTIVE'; echo 'CHECK=FAIL'; fi; else echo 'FIREWALL=NOT_FOUND'; echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": []
        },
        {
            "controlId": "SC-8",
            "title": "Transmission Confidentiality and Integrity: TLS si certificate",
            "category": "Cryptography",
            "description": "Serviciile expuse folosesc criptare in tranzit (TLS) si certificate gestionate. (Family: SC)",
            "severity": "HIGH",
            "automatedChecks": [
                {
                    "checkId": "SC-8.a",
                    "title": "SSL certificates present",
                    "command": "CERTS=0; [ -d /etc/ssl/certs ] && CERTS=$(ls /etc/ssl/certs/*.pem 2>/dev/null | wc -l); LETSENCRYPT='NO'; [ -d /etc/letsencrypt/live ] && LETSENCRYPT='YES'; echo \"SSL_CERTS=$CERTS\"; echo \"LETSENCRYPT=$LETSENCRYPT\"; if [ \"$CERTS\" -gt 0 ]; then echo 'CHECK=PASS'; else echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": [
                {
                    "checkId": "SC-8.M1",
                    "title": "Verificare TLS extern",
                    "instructions": "Incarcati Rezultat scan extern TLS (daca se aplica) si plan remediere.",
                    "evidenceSpec": {
                        "allowUpload": true,
                        "allowLink": true
                    }
                }
            ]
        },
        {
            "controlId": "SI-2",
            "title": "Flaw Remediation: patching si update-uri de securitate",
            "category": "Vulnerability & Patch Management",
            "description": "Update-urile de securitate sunt aplicate la timp, iar restantele sunt urmarite. (Family: SI)",
            "severity": "CRITICAL",
            "automatedChecks": [
                {
                    "checkId": "SI-2.a",
                    "title": "Pending security updates",
                    "command": "if command -v apt >/dev/null 2>&1; then UPGRADABLE=$(apt list --upgradable 2>/dev/null | grep -c -v '^Listing'); echo \"PENDING_UPDATES=$UPGRADABLE\"; if [ \"$UPGRADABLE\" -le 20 ]; then echo 'CHECK=PASS'; else echo 'CHECK=HIGH_PENDING'; fi; elif command -v dnf >/dev/null 2>&1; then COUNT=$(dnf -q check-update 2>/dev/null | grep -c '.'); echo \"PENDING_UPDATES=$COUNT\"; if [ \"$COUNT\" -le 20 ]; then echo 'CHECK=PASS'; else echo 'CHECK=HIGH_PENDING'; fi; else echo 'SKIP_PKG_MGR'; echo 'CHECK=PASS'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": [
                {
                    "checkId": "SI-2.M1",
                    "title": "Verificare politica patching",
                    "instructions": "Incarcati Politica de patching (SLA pe severitati) si Dovada ferestrelor de mentenanta.",
                    "evidenceSpec": {
                        "allowUpload": true,
                        "allowLink": true
                    }
                }
            ]
        },
        {
            "controlId": "SI-3",
            "title": "Malicious Code Protection: detectie malware sau controale echivalente",
            "category": "Threat Management",
            "description": "Exista mecanisme de detectie malware sau masuri echivalente (EDR, ClamAV, integritate). (Family: SI)",
            "severity": "MEDIUM",
            "automatedChecks": [
                {
                    "checkId": "SI-3.a",
                    "title": "Antimalware presence",
                    "command": "FOUND=''; systemctl is-active clamav-freshclam >/dev/null 2>&1 && FOUND=\"$FOUND clamav\"; command -v clamscan >/dev/null 2>&1 && FOUND=\"$FOUND clamscan\"; command -v rkhunter >/dev/null 2>&1 && FOUND=\"$FOUND rkhunter\"; if [ -n \"$FOUND\" ]; then echo \"ANTIMALWARE=$FOUND\"; echo 'CHECK=PASS'; else echo 'ANTIMALWARE=NONE'; echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "SI-3.b",
                    "title": "EDR agent presence",
                    "command": "FOUND=''; for p in falcon-sensor osqueryd elastic-agent wazuh-agent; do pgrep -x \"$p\" >/dev/null 2>&1 && FOUND=\"$FOUND $p\"; done; if [ -n \"$FOUND\" ]; then echo \"EDR_AGENTS=$FOUND\"; echo 'CHECK=PASS'; else echo 'EDR_AGENTS=NONE'; echo 'CHECK=INFO'; fi",
                    "expectedResult": "CHECK=",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": []
        },
        {
            "controlId": "SI-4",
            "title": "System Monitoring: procese, conexiuni, semne de compromitere",
            "category": "Threat Management",
            "description": "Sunt colectate date de monitorizare pentru detectie (procese, conexiuni, persistenta). (Family: SI)",
            "severity": "HIGH",
            "automatedChecks": [
                {
                    "checkId": "SI-4.a",
                    "title": "Process snapshot",
                    "command": "TOTAL=$(ps aux | wc -l); ROOT_PROCS=$(ps -eo user | grep -c '^root'); echo \"TOTAL_PROCESSES=$TOTAL\"; echo \"ROOT_PROCESSES=$ROOT_PROCS\"; echo 'CHECK=PASS'",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "SI-4.b",
                    "title": "Active connections",
                    "command": "ESTABLISHED=$(ss -antup 2>/dev/null | grep -c ESTAB); LISTEN=$(ss -antup 2>/dev/null | grep -c LISTEN); echo \"ESTABLISHED_CONNECTIONS=$ESTABLISHED\"; echo \"LISTENING_PORTS=$LISTEN\"; echo 'CHECK=PASS'",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": []
        },
        {
            "controlId": "IR-4",
            "title": "Incident Handling: colectare rapida dovezi (triage)",
            "category": "Incident Management",
            "description": "Exista capacitate de a colecta dovezi rapide pentru investigatie si raportare. (Family: IR)",
            "severity": "HIGH",
            "automatedChecks": [
                {
                    "checkId": "IR-4.a",
                    "title": "IR tools availability",
                    "command": "TOOLS=''; command -v ps >/dev/null 2>&1 && TOOLS=\"$TOOLS ps\"; command -v ss >/dev/null 2>&1 && TOOLS=\"$TOOLS ss\"; command -v journalctl >/dev/null 2>&1 && TOOLS=\"$TOOLS journalctl\"; command -v last >/dev/null 2>&1 && TOOLS=\"$TOOLS last\"; command -v tcpdump >/dev/null 2>&1 && TOOLS=\"$TOOLS tcpdump\"; COUNT=$(echo $TOOLS | wc -w); echo \"IR_TOOLS=$TOOLS\"; echo \"IR_TOOLS_COUNT=$COUNT\"; if [ \"$COUNT\" -ge 3 ]; then echo 'CHECK=PASS'; else echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": [
                {
                    "checkId": "IR-4.M1",
                    "title": "Verificare procedura IR",
                    "instructions": "Incarcati Procedura IR (roluri, pasi, comunicare, escaladare).",
                    "evidenceSpec": {
                        "allowUpload": true,
                        "allowLink": true
                    }
                }
            ]
        },
        {
            "controlId": "CP-9",
            "title": "System Backup: job-uri, unelte si verificari",
            "category": "Backup & Recovery",
            "description": "Exista backup-uri regulate, separate de sistem, cu retentie si verificari. (Family: CP)",
            "severity": "CRITICAL",
            "automatedChecks": [
                {
                    "checkId": "CP-9.a",
                    "title": "Backup tools presence",
                    "command": "TOOLS=''; command -v restic >/dev/null 2>&1 && TOOLS=\"$TOOLS restic\"; command -v borg >/dev/null 2>&1 && TOOLS=\"$TOOLS borg\"; command -v rclone >/dev/null 2>&1 && TOOLS=\"$TOOLS rclone\"; command -v rsync >/dev/null 2>&1 && TOOLS=\"$TOOLS rsync\"; command -v tar >/dev/null 2>&1 && TOOLS=\"$TOOLS tar\"; if [ -n \"$TOOLS\" ]; then echo \"BACKUP_TOOLS=$TOOLS\"; echo 'CHECK=PASS'; else echo 'BACKUP_TOOLS=NONE'; echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                },
                {
                    "checkId": "CP-9.b",
                    "title": "Cron backup jobs",
                    "command": "JOBS=$(grep -rlE 'backup|restic|borg|rclone|rsync' /etc/cron.* /etc/crontab 2>/dev/null | wc -l); echo \"BACKUP_CRON_JOBS=$JOBS\"; if [ \"$JOBS\" -gt 0 ]; then echo 'CHECK=PASS'; grep -rE 'backup|restic|borg|rclone|rsync' /etc/cron.* /etc/crontab 2>/dev/null | head -n 10; else echo 'CHECK=WARN'; fi",
                    "expectedResult": "CHECK=",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": [
                {
                    "checkId": "CP-9.M1",
                    "title": "Verificare restore si politica",
                    "instructions": "Incarcati Dovada test restore (data, ce s-a restaurat, rezultat) si Politica RPO/RTO.",
                    "evidenceSpec": {
                        "allowUpload": true,
                        "allowLink": true
                    }
                }
            ]
        },
        {
            "controlId": "RA-5",
            "title": "Vulnerability Monitoring and Scanning: semnale pentru vulnerabilitati",
            "category": "Vulnerability & Patch Management",
            "description": "Exista capabilitate de identificare vulnerabilitati (scanner extern, matching pe SBOM/pachete). (Family: RA)",
            "severity": "HIGH",
            "automatedChecks": [
                {
                    "checkId": "RA-5.a",
                    "title": "OS si pachete SBOM",
                    "command": "if [ -f /etc/os-release ]; then . /etc/os-release; echo \"OS=$ID $VERSION_ID\"; fi; echo \"KERNEL=$(uname -r)\"; if command -v dpkg-query >/dev/null 2>&1; then PKG_COUNT=$(dpkg-query -W 2>/dev/null | wc -l); echo \"PACKAGE_COUNT=$PKG_COUNT\"; elif command -v rpm >/dev/null 2>&1; then PKG_COUNT=$(rpm -qa 2>/dev/null | wc -l); echo \"PACKAGE_COUNT=$PKG_COUNT\"; fi; echo 'CHECK=PASS'",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": []
        },
        {
            "controlId": "MA-4",
            "title": "Remote Maintenance: limitare si logare acces administrativ",
            "category": "Operations",
            "description": "Mentenanta remote este limitata, monitorizata si logata (SSH, bastion, jump host). (Family: MA)",
            "severity": "MEDIUM",
            "automatedChecks": [
                {
                    "checkId": "MA-4.a",
                    "title": "SSH login restrictions",
                    "command": "SCORE=0; VALUE=$(sshd -T 2>/dev/null | grep -i 'permitrootlogin' | awk '{print $2}'); echo \"PermitRootLogin=$VALUE\"; echo \"$VALUE\" | grep -qiE '^(no|prohibit-password)$' && SCORE=$((SCORE+1)); VALUE=$(sshd -T 2>/dev/null | grep -i 'maxauthtries' | awk '{print $2}'); echo \"MaxAuthTries=$VALUE\"; [ -n \"$VALUE\" ] && [ \"$VALUE\" -le 5 ] 2>/dev/null && SCORE=$((SCORE+1)); echo \"SSH_HARDENING_SCORE=$SCORE/2\"; if [ \"$SCORE\" -ge 1 ]; then echo 'CHECK=PASS'; else echo 'CHECK=FAIL'; fi",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": [
                {
                    "checkId": "MA-4.M1",
                    "title": "Verificare bastion",
                    "instructions": "Incarcati Dovada existenta bastion/jump (daca e arhitectura respectiva).",
                    "evidenceSpec": {
                        "allowUpload": true,
                        "allowLink": true
                    }
                }
            ]
        },
        {
            "controlId": "PL-2",
            "title": "System Security Plan: documentare minima ceruta",
            "category": "Governance",
            "description": "Exista documentatie minima privind obiectivele de securitate, configuratia si responsabilitatile. (Family: PL)",
            "severity": "LOW",
            "automatedChecks": [],
            "manualChecks": [
                {
                    "checkId": "PL-2.M1",
                    "title": "Verificare SSP",
                    "instructions": "Incarcati System Security Plan (SSP) sau echivalent si Scope si limite, responsabilitati, dependinte.",
                    "evidenceSpec": {
                        "allowUpload": true,
                        "allowLink": true
                    }
                }
            ]
        },
        {
            "controlId": "PE-18",
            "title": "Physical Access: dovada locatie si control acces fizic",
            "category": "Physical & Environmental",
            "description": "Accesul fizic la server este controlat (colo, rack, camera tehnica). (Family: PE)",
            "severity": "MEDIUM",
            "automatedChecks": [],
            "manualChecks": [
                {
                    "checkId": "PE-18.M1",
                    "title": "Verificare acces fizic",
                    "instructions": "Incarcati Politica acces fizic, jurnal acces, contract colo (daca e cazul).",
                    "evidenceSpec": {
                        "allowUpload": true,
                        "allowLink": true
                    }
                }
            ]
        },
        {
            "controlId": "SC-13",
            "title": "Cryptographic Protection: configuratii crypto si modul FIPS",
            "category": "Cryptography",
            "description": "Criptografia folosita este aliniata politicii (algoritmi moderni), iar modul FIPS este activ unde este cerut. (Family: SC)",
            "severity": "MEDIUM",
            "automatedChecks": [
                {
                    "checkId": "SC-13.a",
                    "title": "FIPS si crypto policy",
                    "command": "FIPS=$(cat /proc/sys/crypto/fips_enabled 2>/dev/null); if [ \"$FIPS\" = '1' ]; then echo 'FIPS=ENABLED'; else echo 'FIPS=DISABLED'; fi; if command -v update-crypto-policies >/dev/null 2>&1; then POLICY=$(update-crypto-policies --show 2>/dev/null); echo \"CRYPTO_POLICY=$POLICY\"; fi; OPENSSL=$(openssl version 2>/dev/null); echo \"OPENSSL=$OPENSSL\"; echo 'CHECK=PASS'",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": [
                {
                    "checkId": "SC-13.M1",
                    "title": "Verificare politica crypto",
                    "instructions": "Incarcati Politica criptografica (ce este permis, ce este interzis).",
                    "evidenceSpec": {
                        "allowUpload": true,
                        "allowLink": true
                    }
                }
            ]
        },
        {
            "controlId": "SC-28",
            "title": "Protection of Information at Rest: criptare disc sau date sensibile",
            "category": "Cryptography",
            "description": "Datele sensibile la rest sunt protejate (LUKS, encrypt volumes, KMS), unde este necesar. (Family: SC)",
            "severity": "HIGH",
            "automatedChecks": [
                {
                    "checkId": "SC-28.a",
                    "title": "Block devices si filesystems",
                    "command": "lsblk -f 2>/dev/null | head -n 20; CRYPTO=$(lsblk -f 2>/dev/null | grep -c 'crypto_LUKS'); echo \"LUKS_VOLUMES=$CRYPTO\"; if [ \"$CRYPTO\" -gt 0 ]; then echo 'ENCRYPTION=YES'; else echo 'ENCRYPTION=NO'; fi; echo 'CHECK=PASS'",
                    "expectedResult": "CHECK=PASS",
                    "comparison": "CONTAINS",
                    "checkType": "COMMAND"
                }
            ],
            "manualChecks": [
                {
                    "checkId": "SC-28.M1",
                    "title": "Verificare criptare date",
                    "instructions": "Incarcati Politica de clasificare date si cerinte de criptare.",
                    "evidenceSpec": {
                        "allowUpload": true,
                        "allowLink": true
                    }
                }
            ]
        }
    ]
}