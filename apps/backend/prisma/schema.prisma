// Prisma Schema pentru Platforma Audit Servere
// Generator si datasource

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  // URL is configured in prisma.config.ts
}

// ==================== AUTH & USERS ====================

model User {
  id            String          @id @default(uuid())
  email         String          @unique
  passwordHash  String
  firstName     String?
  lastName      String?
  roleId        String
  role          Role            @relation(fields: [roleId], references: [id])
  permissions   Permission[]
  refreshTokens RefreshToken[]
  auditLogs     AuditLog[]
  templates     Template[]      @relation("TemplateCreator")
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  permissions Json     @default("[]")
  users       User[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("roles")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@map("refresh_tokens")
}

model Permission {
  id           String    @id @default(uuid())
  userId       String
  serverId     String
  capabilities Json      @default("[]")
  expiresAt    DateTime?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  server       Server    @relation(fields: [serverId], references: [id], onDelete: Cascade)
  createdAt    DateTime  @default(now())

  @@unique([userId, serverId])
  @@map("permissions")
}

// ==================== SERVERS & AGENTS ====================

model Server {
  id                 String              @id @default(uuid())
  name               String
  hostname           String?
  ipAddress          String?
  description        String?
  status             ServerStatus        @default(PENDING_ENROLLMENT)
  riskLevel          String?
  agentIdentity      AgentIdentity?
  inventorySnapshots InventorySnapshot[]
  metricSamples      MetricSample[]
  permissions        Permission[]
  auditRuns          AuditRun[]
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt

  @@map("servers")
}

enum ServerStatus {
  PENDING_ENROLLMENT
  ENROLLED
  ONLINE
  OFFLINE
  MAINTENANCE
}

model AgentIdentity {
  id          String   @id @default(uuid())
  serverId    String   @unique
  server      Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  enrollToken String?  @unique
  agentToken  String?  @unique
  version     String?
  osInfo      String?
  lastSeen    DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("agent_identities")
}

model InventorySnapshot {
  id        String   @id @default(uuid())
  serverId  String
  server    Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  osInfo    Json?
  packages  Json?
  services  Json?
  ports     Json?
  processes Json?
  sshConfig Json?
  sysctl    Json?
  firewall  Json?
  users     Json?
  createdAt DateTime @default(now())

  @@index([serverId, createdAt(sort: Desc)])
  @@map("inventory_snapshots")
}

model MetricSample {
  id               String   @id @default(uuid())
  serverId         String
  server           Server   @relation(fields: [serverId], references: [id], onDelete: Cascade)
  cpuPercent       Float?
  memUsedBytes     BigInt?
  memTotalBytes    BigInt?
  diskUsedBytes    BigInt?
  diskTotalBytes   BigInt?
  netInBytes       BigInt?
  netOutBytes      BigInt?
  loadAvg1         Float?
  loadAvg5         Float?
  loadAvg15        Float?
  topProcesses     Json?
  openPortsSummary Json?
  createdAt        DateTime @default(now())

  @@index([serverId, createdAt(sort: Desc)])
  @@map("metric_samples")
}

// ==================== TEMPLATES ====================

model Template {
  id          String            @id @default(uuid())
  name        String
  description String?
  type        TemplateType      @default(CUSTOM)
  isBuiltIn   Boolean           @default(false)
  createdBy   String?
  creator     User?             @relation("TemplateCreator", fields: [createdBy], references: [id], onDelete: SetNull)
  versions    TemplateVersion[]
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  @@map("templates")
}

enum TemplateType {
  CIS_BENCHMARK
  CIS_CONTROLS
  CUSTOM
}

model TemplateVersion {
  id         String    @id @default(uuid())
  templateId String
  template   Template  @relation(fields: [templateId], references: [id], onDelete: Cascade)
  version    String
  changelog  String?
  isActive   Boolean   @default(true)
  controls   Control[]
  auditRuns  AuditRun[]
  createdAt  DateTime  @default(now())

  @@map("template_versions")
}

model Control {
  id              String           @id @default(uuid())
  templateVersionId String
  templateVersion TemplateVersion  @relation(fields: [templateVersionId], references: [id], onDelete: Cascade)
  controlId       String
  title           String
  category        String
  severity        Severity         @default(MEDIUM)
  rationale       String?
  automatedChecks AutomatedCheck[]
  manualChecks    ManualCheck[]
  createdAt       DateTime         @default(now())

  @@map("controls")
}

enum Severity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFO
}

model AutomatedCheck {
  id             String        @id @default(uuid())
  controlId      String
  control        Control       @relation(fields: [controlId], references: [id], onDelete: Cascade)
  checkId        String
  title          String
  description    String?
  command        String?
  script         String?
  expectedResult String?
  checkType      CheckType     @default(COMMAND)
  comparison     Comparison    @default(EQUALS)
  parser         Parser        @default(RAW)
  normalize      Json          @default("[]")
  onFailMessage  String?
  platformScope  Json          @default("[]")
  checkResults   CheckResult[]
  createdAt      DateTime      @default(now())

  @@map("automated_checks")
}

enum CheckType {
  COMMAND
  SCRIPT
  FILE_CHECK
  SERVICE_STATUS
  PACKAGE_VERSION
  SYSCTL
  CUSTOM
}

enum Comparison {
  EQUALS
  NOT_EQUALS
  CONTAINS
  NOT_CONTAINS
  REGEX_MATCH
  GREATER_THAN
  LESS_THAN
  EXISTS
  NOT_EXISTS
}

enum Parser {
  RAW
  JSON
  SPLIT_LINES
  KEY_VALUE
  TRIM
}

model ManualCheck {
  id           String             @id @default(uuid())
  controlId    String
  control      Control            @relation(fields: [controlId], references: [id], onDelete: Cascade)
  checkId      String
  title        String
  description  String?
  instructions String?
  evidenceSpec EvidenceSpec?
  taskResults  ManualTaskResult[]
  createdAt    DateTime           @default(now())

  @@map("manual_checks")
}

model EvidenceSpec {
  id                String      @id @default(uuid())
  manualCheckId     String      @unique
  manualCheck       ManualCheck @relation(fields: [manualCheckId], references: [id], onDelete: Cascade)
  allowUpload       Boolean     @default(true)
  allowLink         Boolean     @default(true)
  allowAttestation  Boolean     @default(true)
  requiresApproval  Boolean     @default(false)
  acceptedFileTypes Json        @default("[]")
  createdAt         DateTime    @default(now())

  @@map("evidence_specs")
}

// ==================== AUDIT RUNS ====================

model AuditRun {
  id                        String             @id @default(uuid())
  serverId                  String
  server                    Server             @relation(fields: [serverId], references: [id], onDelete: Cascade)
  templateVersionId         String
  templateVersion           TemplateVersion    @relation(fields: [templateVersionId], references: [id])
  status                    AuditStatus        @default(PENDING)
  triggeredBy               String?
  excludedControlIds        Json               @default("[]")
  automatedCompliancePercent Float?
  manualCompletionPercent   Float?
  overallStatus             ComplianceStatus?
  startedAt                 DateTime?
  completedAt               DateTime?
  checkResults              CheckResult[]
  manualTaskResults         ManualTaskResult[]
  createdAt                 DateTime           @default(now())
  updatedAt                 DateTime           @updatedAt

  @@index([serverId, createdAt(sort: Desc)])
  @@map("audit_runs")
}

enum AuditStatus {
  PENDING
  RUNNING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

enum ComplianceStatus {
  COMPLIANT
  PARTIALLY_COMPLIANT
  NON_COMPLIANT
}

model CheckResult {
  id               String         @id @default(uuid())
  auditRunId       String
  auditRun         AuditRun       @relation(fields: [auditRunId], references: [id], onDelete: Cascade)
  automatedCheckId String
  automatedCheck   AutomatedCheck @relation(fields: [automatedCheckId], references: [id], onDelete: Cascade)
  status           CheckStatus    @default(PENDING)
  output           String?
  errorMessage     String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@unique([auditRunId, automatedCheckId])
  @@map("check_results")
}

enum CheckStatus {
  PENDING
  PASS
  FAIL
  ERROR
  NA
}

model ManualTaskResult {
  id            String           @id @default(uuid())
  auditRunId    String
  auditRun      AuditRun         @relation(fields: [auditRunId], references: [id], onDelete: Cascade)
  manualCheckId String
  manualCheck   ManualCheck      @relation(fields: [manualCheckId], references: [id], onDelete: Cascade)
  status        ManualTaskStatus @default(PENDING)
  reviewedBy    String?
  reviewedAt    DateTime?
  reviewNotes   String?
  evidence      Evidence[]
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@unique([auditRunId, manualCheckId])
  @@map("manual_task_results")
}

enum ManualTaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  REJECTED
}

model Evidence {
  id                   String           @id @default(uuid())
  manualTaskResultId   String
  manualTaskResult     ManualTaskResult @relation(fields: [manualTaskResultId], references: [id], onDelete: Cascade)
  type                 EvidenceType
  filePath             String?
  fileName             String?
  fileSize             Int?
  mimeType             String?
  fileHash             String?
  link                 String?
  attestation          String?
  uploadedBy           String?
  createdAt            DateTime         @default(now())

  @@map("evidence")
}

enum EvidenceType {
  UPLOAD
  LINK
  ATTESTATION
}

// ==================== AUDIT LOG ====================

model AuditLog {
  id         String   @id @default(uuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String
  resource   String
  resourceId String?
  details    Json?
  ipAddress  String?
  createdAt  DateTime @default(now())

  @@index([createdAt(sort: Desc)])
  @@map("audit_logs")
}
